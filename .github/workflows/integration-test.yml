name: Integrated Test & Report

# 1. 트리거 조건: PR 생성(opened), 업데이트(synchronize) 시 실행
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: ["main", "develop"] # 타겟 브랜치 설정

jobs:
  test-and-report:
    runs-on: ubuntu-latest

    # 2. Redis 서비스 컨테이너 (이게 없으면 테스트에서 Redis 연결 에러 남!)
    services:
      redis:
        image: redis:alpine
        ports:
          - 6379:6379

    steps:
      - name: 체크아웃 (코드 가져오기)
        uses: actions/checkout@v4

      - name: JDK 17 설정
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Gradle 권한 부여
        run: chmod +x gradlew

      # 3. 테스트 실행 (환경변수 주입)
      - name: 통합 테스트 실행
        env:
          # application.yml에서 읽을 변수를 여기서 주입
          TEST_DISCORD_WEBHOOK_URL: ${{ secrets.TEST_DISCORD_WEBHOOK_URL }}
        run: ./gradlew test

      # 4. 엑셀 파일 존재 확인 (디버깅용)
      - name: 엑셀 파일 확인
        run: |
          echo "엑셀 파일 위치를 찾습니다..."
          # 엑셀 파일이 생성되는 정확한 경로를 알아야 합니다.
          # 보통 build/reports/ 혹은 프로젝트 루트에 생길 겁니다.
          find . -name "*.xlsx"

      # 5. 디스코드로 리포트 전송
      - name: 디스코드로 리포트 전송
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.TEST_DISCORD_WEBHOOK_URL }}
        run: |
          # 1. Java가 만든 요약 파일 읽어서 환경변수로 등록
          SUMMARY_FILE="test_summary.properties"

          if [ -f "$SUMMARY_FILE" ]; then
            echo "📄 요약 파일을 로드합니다."
            # 파일 내용을 읽어 export (KEY=VALUE 형태이므로 바로 source 가능하지만, 깃헙 액션 전용 방식 권장)
            cat $SUMMARY_FILE >> $GITHUB_ENV
            
            # 현재 쉘에서도 쓸 수 있게 source 처리 (혹은 직접 변수 할당)
            # 간단하게 grep으로 변수에 담습니다 for displaying in this step
            TOTAL=$(grep "TEST_TOTAL" $SUMMARY_FILE | cut -d'=' -f2)
            PASS=$(grep "TEST_PASS" $SUMMARY_FILE | cut -d'=' -f2)
            FAIL=$(grep "TEST_FAIL" $SUMMARY_FILE | cut -d'=' -f2)
            END_TIME=$(grep "TEST_END_TIME" $SUMMARY_FILE | cut -d'=' -f2)
          else
            echo "⚠️ 요약 파일이 없습니다. 기본값으로 설정합니다."
            TOTAL="Unknown"
            PASS="-"
            FAIL="-"
            END_TIME="-"
          fi

          echo "📊 로드된 데이터 -> 전체: $TOTAL, 성공: $PASS, 실패: $FAIL"

          # 2. 엑셀 파일 경로
          FILE_PATH="./integration_test_report.xlsx"

          if [ -f "$FILE_PATH" ]; then
            echo "🚀 엑셀 파일을 디스코드로 전송합니다."

            # 메시지 구성 (Java가 준 데이터 활용)
            # 줄바꿈 처리를 위해 변수에 미리 담습니다.
            CONTENT="📢 **통합 테스트 결과 리포트** (PR: #${{ github.event.pull_request.number }})\n\n⏰ **종료 시간**: $END_TIME\n📊 **테스트 요약**\n- 🔢 전체: **$TOTAL**건\n- ✅ 성공: **$PASS**건\n- ❌ 실패: **$FAIL**건"
            
            curl -v -F "payload_json={\"content\": \"$CONTENT\"}" \
                 -F "file=@$FILE_PATH" \
                 "$DISCORD_WEBHOOK_URL"
          else
            echo "⚠️ 엑셀 파일이 발견되지 않아 전송을 건너뜁니다."
            # 실패 시에도 알림을 받고 싶다면 아래 주석 해제
            # curl -H "Content-Type: application/json" \
            #      -d "{\"content\": \"🚨 **테스트 실패**\n테스트가 비정상 종료되어 리포트가 없습니다.\n(실패 건수: $FAIL)\"}" \
            #      "$DISCORD_WEBHOOK_URL"
          fi
