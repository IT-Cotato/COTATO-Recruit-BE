name: Auto Release on Develop Merge

on:
  push:
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-branch:
    name: Create Release Branch
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.version.outputs.branch_name }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate version
        id: version
        run: |
          # build.gradleì—ì„œ í˜„ìž¬ ë²„ì „ ì½ê¸°
          CURRENT_VERSION=$(grep "^version = " build.gradle | sed "s/version = '\(.*\)'/\1/")
          echo "Current version in build.gradle: $CURRENT_VERSION"

          # ë²„ì „ì´ YYYY.MM.DD.N í˜•ì‹ì¸ì§€ í™•ì¸
          if [[ $CURRENT_VERSION =~ ^[0-9]{4}\.[0-9]{2}\.[0-9]{2}\.([0-9]+)$ ]]; then
            # ë§ˆì§€ë§‰ ìˆ«ìžë¥¼ 1 ì¦ê°€
            COUNTER=${BASH_REMATCH[1]}
            COUNTER=$((COUNTER + 1))
            DATE=$(echo $CURRENT_VERSION | cut -d'.' -f1-3)
          else
            # ë²„ì „ í˜•ì‹ì´ ë‹¤ë¥´ë©´ ìƒˆë¡œ ìƒì„±
            DATE=$(date +'%Y.%m.%d')
            COUNTER=1
          fi

          VERSION="$DATE.$COUNTER"
          echo "New version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "branch_name=release/$VERSION" >> $GITHUB_OUTPUT

      - name: Create release branch
        run: |
          git checkout -b ${{ steps.version.outputs.branch_name }}
          git push origin ${{ steps.version.outputs.branch_name }}

      - name: Update version in build.gradle
        run: |
          sed -i "s/version = .*/version = '${{ steps.version.outputs.version }}'/" build.gradle
          if git diff --quiet build.gradle; then
            echo "âœ… Version already up to date: ${{ steps.version.outputs.version }}"
          else
            git add build.gradle
            git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
            git push origin ${{ steps.version.outputs.branch_name }}
            echo "âœ… Version updated to: ${{ steps.version.outputs.version }}"
          fi

      - name: Summary
        run: |
          echo "âœ… Release branch created: ${{ steps.version.outputs.branch_name }}"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "ðŸš€ Triggering QA deployment..."

  deploy-to-qa:
    name: Deploy to QA Server
    needs: create-release-branch
    uses: ./.github/workflows/deploy-qa.yml
    with:
      ref: ${{ needs.create-release-branch.outputs.branch_name }}
    secrets: inherit
